<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>ARC Prize 2025 - Local Task Browser</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="js/common.js"></script>
        <script src="js/testing_interface.js"></script>
        <script src="js/local_loader.js"></script>

        <link rel="stylesheet" type="text/css" href="css/common.css">
        <link rel="stylesheet" type="text/css" href="css/testing_interface.css">

        <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">

        <style>
            #task_selector {
                background: #f0f0f0;
                padding: 20px;
                margin: 20px;
                border-radius: 8px;
                max-width: 800px;
            }

            #task_list {
                max-height: 400px;
                overflow-y: auto;
                background: white;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 10px;
                margin-top: 10px;
            }

            .task_item {
                padding: 8px;
                margin: 4px 0;
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .task_item:hover {
                background: #e3f2fd;
                border-color: #2196F3;
            }

            .task_item.selected {
                background: #2196F3;
                color: white;
                border-color: #1976D2;
            }

            #dataset_selector {
                margin-bottom: 15px;
            }

            #dataset_selector button {
                margin: 5px;
                padding: 10px 20px;
                font-size: 14px;
                cursor: pointer;
                background: #2196F3;
                color: white;
                border: none;
                border-radius: 4px;
                transition: background 0.2s;
            }

            #dataset_selector button:hover {
                background: #1976D2;
            }

            #dataset_selector button.active {
                background: #1565C0;
            }

            #task_count {
                margin-top: 10px;
                font-style: italic;
                color: #666;
            }
        </style>

    </head>
    <body>
        <div id="task_selector">
            <h2>üß© ARC Prize 2025 - Task Browser</h2>

            <div id="dataset_selector">
                <label>Select Dataset:</label><br>
                <button onclick="loadDataset('training')" id="btn_training">Training (400 tasks)</button>
                <button onclick="loadDataset('evaluation')" id="btn_evaluation">Evaluation (400 tasks)</button>
                <button onclick="loadDataset('test')" id="btn_test">Test (Competition)</button>
            </div>

            <div id="task_count"></div>

            <div id="task_list">
                <p style="text-align: center; color: #999;">Select a dataset above to load tasks</p>
            </div>

            <button onclick="startTask()" id="start_task_btn" style="margin-top: 15px; padding: 12px 30px; font-size: 16px;" disabled>
                Start Selected Task ‚Üí
            </button>
        </div>

        <div id="modal_bg" style="display: none;">
            <div id="modal">
                <div>Loading task... Please wait.</div>
            </div>
        </div>

        <div id="workspace" style="display: none;">

            <div id="demonstration_examples_view">
                <div class="text" id="task_demo_header">Task demonstration</div>
                <div id="task_preview"></div>
            </div>

            <div id="evaluation_view">

                <div id="evaluation-input-view">
                    <div class="text">Test input grid <span id="current_test_input_id_display">0</span>/<span id="total_test_input_count_display">0</span>
                        <button onclick="nextTestInput()">Next test input</button>
                        <button onclick="backToTaskList()">‚Üê Back to Task List</button>
                    </div>

                    <div id="evaluation_input" class="selectable_grid"></div>
                </div>

                <div id="evaluation_output_editor">

                    <div id="load_task_control_btns">
                        <label id='task_name' for="random_task_btn"> Current Task: </label>
                        <p>
                        <label for="show_symbol_numbers">Show symbol numbers: </label>
                        <input type="checkbox" id="show_symbol_numbers" name="show_symbol_numbers"
                        onchange="changeSymbolVisibility()">
                    </div>

                    <div id="edition_view">
                        <div id="editor_grid_control_btns">
                            <div id="resize_control_btns">
                                <label for="output_grid_size">Change grid size: </label>
                                <input type="text" id="output_grid_size" class="grid_size_field" name="size" value="3x3">
                                <button onclick="resizeOutputGrid()" id="resize_btn">Resize</button>
                            </div>

                            <button onclick="copyFromInput()">Copy from input</button>
                            <button onclick="resetOutputGrid()">Reset grid</button>
                            <button onclick="submitSolution()" id="submit_solution_btn">Submit!</button>
                        </div>

                        <div id="output_grid">
                            <div class="edition_grid selectable_grid">
                                <div class="row">
                                    <div class="cell" symbol="0" x="0" y="0"></div>
                                    <div class="cell" symbol="0" x="0" y="1"></div>
                                    <div class="cell" symbol="0" x="0" y="2"></div>
                                </div>
                                <div class="row">
                                    <div class="cell" symbol="0" x="1" y="0"></div>
                                    <div class="cell" symbol="0" x="1" y="1"></div>
                                    <div class="cell" symbol="0" x="1" y="2"></div>
                                </div>
                                <div class="row">
                                    <div class="cell" symbol="0" x="2" y="0"></div>
                                    <div class="cell" symbol="0" x="2" y="1"></div>
                                    <div class="cell" symbol="0" x="2" y="2"></div>
                                </div>
                            </div>
                        </div>


                        <div id="toolbar">
                            <div>
                                <input type="radio" id="tool_edit"
                                 name="tool_switching" value="edit" checked>
                                <label for="tool_edit">Edit</label>

                                <input type="radio" id="tool_select"
                                 name="tool_switching" value="select">
                                <label for="tool_select">Select</label>

                                <input type="radio" id="tool_floodfill"
                                 name="tool_switching" value="floodfill">
                                <label for="tool_floodfill">Flood fill</label>
                            </div>
                        </div>

                        <div id="symbol_picker">
                            <div class="symbol_preview symbol_0 selected-symbol-preview" symbol="0"></div>
                            <div class="symbol_preview symbol_1" symbol="1"></div>
                            <div class="symbol_preview symbol_2" symbol="2"></div>
                            <div class="symbol_preview symbol_3" symbol="3"></div>
                            <div class="symbol_preview symbol_4" symbol="4"></div>
                            <div class="symbol_preview symbol_5" symbol="5"></div>
                            <div class="symbol_preview symbol_6" symbol="6"></div>
                            <div class="symbol_preview symbol_7" symbol="7"></div>
                            <div class="symbol_preview symbol_8" symbol="8"></div>
                            <div class="symbol_preview symbol_9" symbol="9"></div>
                        </div>
                    </div>

                    <div id="error_display"></div>
                    <div id="info_display"></div>
                </div>
            </div>
        </div>

        <script>
            // Global state
            let currentDataset = null;
            let allTasks = {};
            let selectedTaskId = null;
            let currentTask = null;

            function loadDataset(dataset) {
                currentDataset = dataset;

                // Update button styles
                $('#dataset_selector button').removeClass('active');
                $(`#btn_${dataset}`).addClass('active');

                // Determine file path
                let filePath = '';
                if (dataset === 'training') {
                    filePath = '../arc-agi_training_challenges.json';
                } else if (dataset === 'evaluation') {
                    filePath = '../arc-agi_evaluation_challenges.json';
                } else if (dataset === 'test') {
                    filePath = '../arc-agi_test_challenges.json';
                }

                // Load JSON
                $.getJSON(filePath)
                    .done(function(data) {
                        allTasks = data;
                        displayTaskList(data);
                    })
                    .fail(function(jqxhr, textStatus, error) {
                        $('#task_list').html(`
                            <p style="color: red; text-align: center;">
                                ‚ùå Failed to load ${dataset} dataset<br>
                                Error: ${error}<br>
                                <small>Make sure arc-agi_${dataset}_challenges.json exists in parent directory</small>
                            </p>
                        `);
                    });
            }

            function displayTaskList(tasks) {
                let taskIds = Object.keys(tasks);
                let html = '';

                taskIds.forEach(taskId => {
                    let task = tasks[taskId];
                    let trainCount = task.train ? task.train.length : 0;
                    let testCount = task.test ? task.test.length : 0;

                    html += `
                        <div class="task_item" onclick="selectTask('${taskId}')">
                            <strong>${taskId}</strong>
                            <span style="float: right; color: #666;">
                                ${trainCount} train, ${testCount} test
                            </span>
                        </div>
                    `;
                });

                $('#task_list').html(html);
                $('#task_count').text(`${taskIds.length} tasks loaded from ${currentDataset} dataset`);
                $('#start_task_btn').prop('disabled', true);
                selectedTaskId = null;
            }

            function selectTask(taskId) {
                selectedTaskId = taskId;

                // Update UI
                $('.task_item').removeClass('selected');
                $(`.task_item:contains('${taskId}')`).first().addClass('selected');

                $('#start_task_btn').prop('disabled', false);
            }

            function startTask() {
                if (!selectedTaskId || !allTasks[selectedTaskId]) {
                    alert('Please select a task first');
                    return;
                }

                currentTask = {
                    task_id: selectedTaskId,
                    task: allTasks[selectedTaskId]
                };

                // Hide selector, show workspace
                $('#task_selector').hide();
                $('#workspace').show();

                // Load task into interface
                loadTaskIntoInterface(currentTask.task, selectedTaskId);
            }

            function backToTaskList() {
                $('#workspace').hide();
                $('#task_selector').show();
                resetState();
            }

            function loadTaskIntoInterface(task, taskName) {
                // This is called by the existing ARC interface code
                // We need to set up the global state that testing_interface.js expects

                window.currentTask = task;
                window.currentTaskName = taskName;

                // Display task name
                $('#task_name').text('Task: ' + taskName);

                // Load training examples
                $('#task_preview').empty();
                for (let i = 0; i < task.train.length; i++) {
                    let pair = task.train[i];
                    let pairView = $('<div class="pair_preview" id="pair_preview_' + i + '"></div>');

                    let inputGrid = convertSerializedGridToGridObject(pair.input);
                    let outputGrid = convertSerializedGridToGridObject(pair.output);

                    pairView.append($('<div>').html('Input<br>').append(drawGrid(inputGrid)));
                    pairView.append($('<div>').html('Output<br>').append(drawGrid(outputGrid)));

                    $('#task_preview').append(pairView);
                }

                // Load test inputs
                window.test_input_grids = [];
                for (let i = 0; i < task.test.length; i++) {
                    let testInput = task.test[i].input;
                    window.test_input_grids.push(convertSerializedGridToGridObject(testInput));
                }

                window.currentTestInputIndex = 0;
                $('#total_test_input_count_display').text(window.test_input_grids.length);

                // Display first test input
                if (window.test_input_grids.length > 0) {
                    $('#current_test_input_id_display').text(1);
                    displayEvaluationInput(window.test_input_grids[0]);

                    // Initialize output grid with same size as input
                    let inputGrid = window.test_input_grids[0];
                    let height = inputGrid.height;
                    let width = inputGrid.width;
                    $('#output_grid_size').val(height + 'x' + width);
                    resizeOutputGrid();
                }
            }

            // Auto-load training dataset on page load
            $(document).ready(function() {
                console.log('ARC Prize 2025 Local Interface Ready');
            });
        </script>
    </body>
</html>
